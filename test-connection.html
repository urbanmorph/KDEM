<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KDEM Supabase Connection Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #1a73e8;
      margin-bottom: 10px;
    }
    .status {
      padding: 20px;
      border-radius: 6px;
      margin: 20px 0;
    }
    .loading {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      color: #856404;
    }
    .success {
      background: #d4edda;
      border-left: 4px solid #28a745;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      border-left: 4px solid #dc3545;
      color: #721c24;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    li:last-child {
      border-bottom: none;
    }
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }
    .badge-success {
      background: #28a745;
      color: white;
    }
    .badge-danger {
      background: #dc3545;
      color: white;
    }
    code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #1a73e8;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 10px;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .test-details {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    .test-details h3 {
      margin-top: 0;
      color: #495057;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ”Œ KDEM Supabase Connection Test</h1>
    <p>Testing connection to: <code>https://xtuedwbeflrbkbknakgv.supabase.co</code></p>

    <div id="status" class="status loading">
      <div class="spinner"></div>
      <strong>Testing connection...</strong>
    </div>

    <div id="details"></div>
  </div>

  <script type="module">
    import { supabase, db, rpc } from './src/lib/supabaseClient.js'

    async function testConnection() {
      const statusEl = document.getElementById('status')
      const detailsEl = document.getElementById('details')

      const tests = []

      try {
        // Test 1: Fetch verticals
        console.log('Test 1: Fetching verticals...')
        const { data: verticals, error: vError } = await db.verticals().select('*')
        if (vError) throw new Error(`Verticals error: ${vError.message}`)
        tests.push({ name: 'Verticals', count: verticals.length, success: true })

        // Test 2: Fetch geographies
        console.log('Test 2: Fetching geographies...')
        const { data: geographies, error: gError } = await db.geographies().select('*')
        if (gError) throw new Error(`Geographies error: ${gError.message}`)
        tests.push({ name: 'Geographies', count: geographies.length, success: true })

        // Test 3: Fetch factors
        console.log('Test 3: Fetching factors...')
        const { data: factors, error: fError } = await db.factors().select('*')
        if (fError) throw new Error(`Factors error: ${fError.message}`)
        tests.push({ name: 'Factors', count: factors.length, success: true })

        // Test 4: Fetch conversion ratios
        console.log('Test 4: Fetching conversion ratios...')
        const { data: ratios, error: rError } = await db.conversionRatios().select('*')
        if (rError) throw new Error(`Conversion ratios error: ${rError.message}`)
        tests.push({ name: 'Conversion Ratios', count: ratios.length, success: true })

        // Test 5: Fetch apportionment rules
        console.log('Test 5: Fetching apportionment rules...')
        const { data: rules, error: rulesError } = await db.apportionmentRules().select('*')
        if (rulesError) throw new Error(`Apportionment rules error: ${rulesError.message}`)
        tests.push({ name: 'Apportionment Rules', count: rules.length, success: true })

        // Test 6: Test database function
        console.log('Test 6: Testing database function...')
        const { data: apportionment, error: funcError } = await rpc.generateDefaultApportionment('it-exports', 2030)
        if (funcError) throw new Error(`Function error: ${funcError.message}`)
        tests.push({ name: 'Database Functions', count: apportionment?.length || 0, success: true })

        // Test 7: Fetch views
        console.log('Test 7: Fetching materialized views...')
        const { data: dashboard, error: viewError } = await db.geographyDashboard().select('*').limit(1)
        if (viewError) throw new Error(`View error: ${viewError.message}`)
        tests.push({ name: 'Materialized Views', count: 'Working', success: true })

        // All tests passed!
        statusEl.className = 'status success'
        statusEl.innerHTML = `
          <h2 style="margin-top: 0;">âœ“ Connection Successful!</h2>
          <p>All database tests passed. Your Supabase setup is complete!</p>
        `

        detailsEl.innerHTML = `
          <div class="test-details">
            <h3>Test Results:</h3>
            <ul>
              ${tests.map(test => `
                <li>
                  <strong>${test.name}:</strong> ${test.count} ${typeof test.count === 'number' ? 'records' : ''} found
                  <span class="badge badge-success">âœ“ PASS</span>
                </li>
              `).join('')}
            </ul>
          </div>

          <div class="test-details">
            <h3>Sample Data Check:</h3>
            <ul>
              <li><strong>Core Verticals:</strong> ${verticals.filter(v => v.category === 'core').map(v => v.name).join(', ')}</li>
              <li><strong>Tier 1 Clusters:</strong> ${geographies.filter(g => g.tier === 'tier1-invest-aggressively').map(g => g.name).join(', ')}</li>
              <li><strong>Factors:</strong> ${factors.map(f => f.name).join(', ')}</li>
            </ul>
          </div>

          <div class="test-details">
            <h3>âœ… Ready for Next Steps:</h3>
            <ol>
              <li>âœ“ Supabase project configured</li>
              <li>âœ“ Database schema created (9 tables, 3 views)</li>
              <li>âœ“ Seed data loaded (${ratios.length} conversion ratios, ${rules.length} apportionment rules)</li>
              <li>âœ“ Database functions working</li>
              <li>âœ“ Frontend connection verified</li>
            </ol>
            <p><strong>You can now proceed with Phase 2: Building the dashboard!</strong></p>
            <p>See <code>docs/IMPLEMENTATION_GUIDE.md</code> for next steps.</p>
          </div>
        `

      } catch (error) {
        console.error('Connection test failed:', error)

        statusEl.className = 'status error'
        statusEl.innerHTML = `
          <h2 style="margin-top: 0;">âœ— Connection Failed</h2>
          <p><strong>Error:</strong> ${error.message}</p>
        `

        detailsEl.innerHTML = `
          <div class="test-details">
            <h3>Troubleshooting Steps:</h3>
            <ol>
              <li>
                <strong>Check your .env file:</strong>
                <ul>
                  <li>Make sure <code>VITE_SUPABASE_URL</code> is set to: <code>https://xtuedwbeflrbkbknakgv.supabase.co</code></li>
                  <li>Make sure <code>VITE_SUPABASE_ANON_KEY</code> is filled in (get from Supabase dashboard â†’ Settings â†’ API)</li>
                  <li>Make sure you're using the <strong>anon public</strong> key, NOT the service_role key</li>
                </ul>
              </li>
              <li>
                <strong>Check database migrations:</strong>
                <ul>
                  <li>Go to Supabase dashboard â†’ SQL Editor</li>
                  <li>Run all 3 migration files in order (001, 002, 003)</li>
                  <li>Then run both seed files (001, 002)</li>
                  <li>See SUPABASE_SETUP.md for detailed instructions</li>
                </ul>
              </li>
              <li>
                <strong>Restart dev server:</strong>
                <ul>
                  <li>Press Ctrl+C in terminal</li>
                  <li>Run <code>npm run dev</code> again</li>
                  <li>Refresh this page</li>
                </ul>
              </li>
            </ol>

            <h3>Tests Run:</h3>
            <ul>
              ${tests.map(test => `
                <li>
                  <strong>${test.name}:</strong> ${test.success ? test.count + ' records' : 'Failed'}
                  <span class="badge ${test.success ? 'badge-success' : 'badge-danger'}">
                    ${test.success ? 'âœ“ PASS' : 'âœ— FAIL'}
                  </span>
                </li>
              `).join('')}
            </ul>
          </div>
        `
      }
    }

    // Run tests on page load
    testConnection()
  </script>
</body>
</html>
